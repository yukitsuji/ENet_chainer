"""
Blockの中身は基本いじらない
Bottleneckの構成を色々試してみる

typeでBlockまたはBottleneckを設定できる
Bottlenecで対応可能なparamは、Defaultのみ
"""
end_trigger: [90000, "iteration"]
results: results/sample
gpus:
mode: Train
seed: 1

model:
  enet:
    initial_block:
      type: initial
      args:
        in_ch: 3
        out_ch: 13
        ksize: 3
        stride: 2
        pad: 1
        nobias: False

    bottleneck1_0:
      type: block
      args:
        in_ch: 16
        mid_ch: 16
        out_ch: 64
        downsample: True
        drop_ratio: 0.01

    bottleneck1_1:
      type: block
      loop: 4
      args:
        in_ch: 64
        mid_ch: 16
        out_ch: 64
        drop_ratio: 0.01

    bottleneck2_0:
      type: block
      args:
        in_ch: 64
        mid_ch: 32
        out_ch: 128
        downsample: 1

    bottleneck2_1:
      type: bottleneck2
      loop: 2
      args:
        in_ch: 128
        mid_ch: 32
        out_ch: 128

    fullconv:
      type: fullconv
      args:
        in_ch: 128
  use_dec: False

model:
  module: pspnet
  name: PSPNet
  args:
    n_class: 19
    input_size: [713, 713]
    n_blocks: [3, 4, 23, 3]
    pyramids: [6, 3, 2, 1]
    mid_stride: true

dataset:
  train:
    module: datasets
    name: CityscapesTransformedDataset
    args:
      data_dir: data/cityscapes
      label_resolution: gtFine
      split: train
      ignore_labels: true
      crop_size: [713, 713]
      color_sigma: null
      scale: [0.5, 2.0]
      rotate: False
      fliplr: True
      n_class: 19
    batchsize: 1

  valid:
    module: dataset
    name: CityscapesTransformedDataset
    args:
      data_dir: data/cityscapes
      label_resolution: gtFine
      split: val
      ignore_labels: true
      crop_size: [713, 713]
      color_sigma: null
      scale: null
      rotate: False
      fliplr: False
      n_class: 19
    batchsize: 1

loss:
  module: loss.pspnet_loss
  name: PixelwiseSoftmaxClassifier
  args:
    ignore_label: -1
    class_weight_npy: dataset/cityscapes/class_weight_gtFine.npy

updater:
  type:
  name: StatelessRnnUpdater
  args:
    iou_thres: 0.8
    accuracy: True

iterator:
  name: SerialIterator
  batchsize: 16

optimizer:
  name: MomentumSGD
  args:
    lr: 0.01
    momentum: 0.9
  weight_decay: 0.0001
  lr_drop_poly_power: 0.9

extension:
  Evaluator:
    type: rnn
    name: StatelessRnnEvaluator
    args:
      accuracy: True
      iou_thres: 0.75
  dump_graph:
      name: main/total_loss
  snapshot:
      trigger: [1, "epoch"]
  LogReport:
    trigger: [1, "epoch"]
  PrintReport:
    name:
      epoch
      iteration
      main/total_loss
      main/accuracy
      val/main/total_loss
      val/main/accuracy
      # lr
    trigger: [1, "epoch"]
  ProgressBar:
      update_interval: 10
